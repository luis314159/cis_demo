<!-- templates/admin_items.html -->
{% extends 'base.html' %}

{% block title %}Administrar Items{% endblock %}

{% block content %}
<h1 class="text-center">Administrar Items</h1>

<div class="mb-3">
    <label for="job-filter" class="form-label">Filtrar por Job:</label>
    <select id="job-filter" class="form-select">
        <!-- Opciones serán cargadas dinámicamente -->
    </select>
</div>

<table class="table table-bordered">
    <thead>
        <tr>
            <th>Item Name</th>
            <th>Stage</th>
            <th>Count</th>
            <th>Acciones</th>
        </tr>
    </thead>
    <tbody id="items-table">
        <!-- Los datos serán cargados dinámicamente -->
    </tbody>
</table>

<script>
    async function loadJobsForFilter() {
        try {
            const response = await fetch('/jobs/list');
            const jobs = await response.json();
            const jobFilter = document.getElementById('job-filter');

            jobFilter.innerHTML = '<option value="">Selecciona un Job</option>';
            jobs.forEach(job => {
                const option = document.createElement('option');
                option.value = job.job_code;
                option.textContent = job.job_code;
                jobFilter.appendChild(option);
            });
        } catch (error) {
            console.error('Error cargando jobs:', error);
            alert('Error al cargar los jobs. Por favor, intenta de nuevo más tarde.');
        }
    }

    async function loadItems(jobCode) {
        if (!jobCode) {
            document.getElementById('items-table').innerHTML = '';
            return;
        }

        try {
            const response = await fetch(`/jobs/${jobCode}/status`);
            const data = await response.json();
            const itemsTable = document.getElementById('items-table');

            itemsTable.innerHTML = '';
            
            // Comprobamos si hay objetos para iterar
            if (data.objects && Array.isArray(data.objects)) {
                data.objects.forEach(item => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${item.item_name}</td>
                        <td>${item.stage_name}</td>
                        <td>${item.count}</td>
                        <td>
                            <button class="btn btn-danger" onclick="deleteItem('${item.item_name}')">Eliminar</button>
                        </td>
                    `;
                    itemsTable.appendChild(row);
                });
            } else {
                itemsTable.innerHTML = '<tr><td colspan="4" class="text-center">No hay items disponibles para este job</td></tr>';
            }
        } catch (error) {
            console.error('Error cargando items:', error);
            document.getElementById('items-table').innerHTML = 
                '<tr><td colspan="4" class="text-center">Error al cargar los items. Por favor, intenta de nuevo más tarde.</td></tr>';
        }
    }

    async function deleteItem(itemName) {
        if (confirm(`¿Estás seguro de que quieres eliminar el Item '${itemName}'?`)) {
            try {
                // Aquí asumo que el endpoint para eliminar es por el nombre del item,
                // ajusta según tu API real
                const response = await fetch(`/items/${encodeURIComponent(itemName)}`, { 
                    method: 'DELETE' 
                });
                
                if (response.ok) {
                    alert('Item eliminado correctamente');
                    const jobCode = document.getElementById('job-filter').value;
                    loadItems(jobCode);
                } else {
                    const errorData = await response.json().catch(() => null);
                    alert(`Error al eliminar el Item: ${errorData?.message || response.statusText}`);
                }
            } catch (error) {
                console.error('Error eliminando item:', error);
                alert('Error al eliminar el Item. Por favor, intenta de nuevo más tarde.');
            }
        }
    }

    document.getElementById('job-filter').addEventListener('change', (e) => {
        loadItems(e.target.value);
    });

    // Cargar los jobs al iniciar la página
    document.addEventListener('DOMContentLoaded', () => {
        loadJobsForFilter();
    });
</script>
{% endblock %}